services:

  test-basic:
    image: ghcr.io/driplineorg/dripline-python:${DLPY_IMG_TAG:-latest-dev}
    depends_on:
      - rabbit-broker
      - simple-service
    volumes:
      - ./run-tests-basic.bats:/root/run-tests-basic.bats
    command: >
      bash -c "sleep 1 &&
              /root/run-tests-basic.bats &&
              /bin/true"
    configs:
      - dl_pw.txt

  test-core:
    image: ghcr.io/driplineorg/dripline-python:${DLPY_IMG_TAG:-latest-dev}
    depends_on:
      - rabbit-broker
#      - key-value-store
#      - base-service
      - alert-consumer
    volumes:
      - ./run-tests-core.bats:/root/run-tests-core.bats
    command: >
      bash -c "sleep 1 &&
              /root/run-tests-core.bats &&
              /bin/true"
    configs:
      - dl_pw.txt

  # The bare alert consumer
  alert-consumer:
    image: ghcr.io/driplineorg/dripline-python:${DLPY_IMG_TAG:-latest-dev}
    depends_on:
      rabbit-broker:
        condition: service_healthy
    volumes:
      - ./services/alert-consumer.yaml:/root/alert-consumer.yaml
    command: >
      bash -c "dl-serve -vv -b rabbit-broker -u dripline --password-file /dl_pw.txt -c /root/alert-consumer.yaml"
    configs:
      - dl_pw.txt